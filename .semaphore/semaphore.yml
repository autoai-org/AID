version: v1.0
name: Docker
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Build Discovery
    task:
      jobs:
        - name: Docker Build
          commands:
            - checkout
            - docker build -t aid-discovery ./components/discovery
  - name: Deploy Discovery to Heroku
    task:
      secrets:
        - name: Heroku Authorization Token
      jobs:
        - name: Deploy to Heroku
          commands:
            - docker login --username=_ --password=$HEROKU_TOKEN registry.heroku.com
            - 'docker tag aid-discovery:latest registry.heroku.com/aid-discovery/web'
            - docker push registry.heroku.com/aid-discovery/web
